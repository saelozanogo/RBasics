---
title: "TRABAJO FINAL R - RENTABILIDAD FINCOMERCIO"
author: "Neyder Giraldo - Lina Mojica"
date: "26/5/2020"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

La empresa cooperativa de ahorro y credito fincomercio ltda. semestralmente realiza la verificación de las rentabilidades de cada una de sus oficinas,este proceso es muy tedioso y desgastante para el analista, por tal motivo se decidio dentro de la clase de R realizar un codigo que permita obtener la rentabilidad de las oficinas de forma aguil y rapida, mejorando la optimización de los procesos.

### LLAMADA DE DATOS

Con la ayuda de VBA Excel, logramos clasificar seleccionar los datos que necesitamos, facilitando el trabajo de R al momento  de almacenar sus  datos, para le cual se crean dos variables:  1. oficinas que va almacenar los nombres de las oficinas, su codigo interno y su nivel de importancia, 2. datos que se encargara de almacenar los datos de todas las oficinas de fincomercio ltda.

```{r}

library(readxl)
library(ggplot2)
library(hrbrthemes)

oficina = read_excel("C:/Users/RentAdvisor/Desktop/PROYECTO R STUDIO/TRABAJO RENTABILIDAD Rstudio.xlsm", sheet = "OFICINAS")

datos = read_excel("C:/Users/RentAdvisor/Desktop/PROYECTO R STUDIO/TRABAJO RENTABILIDAD Rstudio.xlsm", sheet = "DATOS")

str(datos[1:61,1:4])
str(oficina)

```

### CREACION DE UN VECTOR Y CADA DATA.FRAME

Podemos observar que tenemos 47 oficinas con su  serie e importancia, en datos una pequeña muestra de como esta compuesta por  detalle (cuentas de balance), valor promedio, tasa y ingresos/egresos, se hace necesario crear una forma facíl de obtener los datos para esto se crea el vector en el cual se almacenaran data.frame de cada una de las oficinas las cuales se obtendrán de la base datos,cabe mencionar que los datos de cada oficina tiene al final el respectivo numero codigo de oficina para que no se genere desorden, es decir acumludado año corresponde al codigo 1 por lo tanto  vr. promedio, tasa (m.v.) y ing/egr deben tener al final 1 y  asi sucesivamente en cada oficina.

```{r}

i=1
o=2
d.f = c()
while(i<=47){
  a= datos[1:61,1]
  b= c(datos[1:61,o])
  c= c(datos[1:61,o+1])
  d=c(datos[1:61,o+2])
  d.f[[i]]= data.frame (a,b,c,d)
  i=i+1
  o=o+3
}

d.f[1]

```

### RENTABILIDAD DE FINCOMERCIO QUE SE ESPERA 

Esta es la rentabilidad que fincomercio necesita para poder seguir  en funcionamiento  y no se convierta en una empresa que no genera rentabilidad para sus asociados, esta rentabilidad de obtiene de la siguiente forma.

Se extrae del primer data.frame, su tercera columna y la posición 61.

```{r}

renta <-d.f[[1]][[3]][61]
renta

```

### RENTABILIDAD OBTENIDA

Es la rentabilidad que Fincomercio tiene actualmente de todas sus oficinas la cual se obtiene de la siguiente forma.

Se extrae del cuarto data.frame, su tercera columna y la posición 61.

```{r}

ren.1 <- d.f[[4]][[3]][61]
ren.1

```
### PREGUNTA LOGICA RENTABILIDAD

Se constata si las dos rentabilidades son iguales.

```{r}

renta==ren.1

```
### FONDEO PROMEDIO

El fondeo es el  dinero que la oficina principal tiene que prestar a sus oficinas para poder cubrir sus obligaciones, el fondeo promedio nos permite conocer el valor que en promedio ha necesitado las oficinas para fondearse.

El resultado  es un vector que almacena el fondeo  de anda una cabe aclarar que las 4 primeras oficinas no se fondean ya que son datos de la base. 

```{r}

i=5
f.p= c()
while (i<=47){
  tc = d.f[[i]][[2]][8]
  tcp= d.f[[i]][[2]][31]
  as= d.f[[i]][[2]][41]
  x= tc-tcp-as
  if (x>0){
    f.p[i]=x
  }else{
    f.p[i]= 0
  }
  i=i+1
}
f.p

```
### RENTABILIDADES BASE

Con este codigo permitimos conocer las rentabilidades de las oficinas de fincomercio hasta el momento sin realizar ningún cambio dentro de la base de datos es descir que sin el fondeo.

```{r}

rentx= c()
ofiy= oficina$IMPORTANCIA[5:47]
i=5
rb = c()

while(i<=47){
  rb[i]=d.f[[i]][[3]][61]
  i=i+1
}
rb

```

### SIMULADOR

Es necesario hallar la tasa a la cual se le va prestar el fondeo a las oficinas para que la rentabilidad de fincomercio pase de negatica a cumplir con la esperada. Hay oficinas que no necesitan ser fondeadas es decir que tuvieron ingresos lo cual es bueno para la empresa.

```{r}

z = d.f[[4]][[2]][61]
j = d.f[[4]][[4]][61]
i=0.0
p= 0

while (p<renta) {
  o=5
  fon=c()
  ing=c()
  
  while (o<=47) {
    
    fon[o]=f.p[o]*i
    
    if(f.p[o]==0){
      
      ing[o]= ((d.f[[o]][[2]][31]+d.f[[o]][[2]][41]-d.f[[o]][[2]][15])*i/12*6)
    }else{
      
      ing[o]=0
    }
    
    o=o+1
  }
  
  s=sum(fon,na.rm = TRUE)-sum(ing,na.rm = TRUE)
  d= j+s
  p=d/z
  i= i+ 0.00001
  
}
fon = as.integer(fon)
# FONDEO

fon
ing = as.integer(ing)
#INGRESOS
ing
# TOTAL DE FONDEO
s
tasa = i-0.00001
# TASA
tasa

```

### CUADRO DE FONDEO E INGRESOS

El cuadro permite ver en un data.frame organizado  sabiendo cuales oficinas necesitan fondeo o por el contrario generan ingresos.

```{r}

cuadro.1 = data.frame("OFICINA"=oficina$OFICINA[5:47],"CODIGO" = ofiy,"PROMEDIO_FONDEO"=f.p[5:47],"FONDEO_OFICINA"=fon[5:47],"INGRESOS_FONDEO"= ing[5:47])
cuadro.1

```

###Rentabilidad

Conociendo el fondeo la tasa de la mesa de dinero que es la cual los bancos les presta a sus oficinas se puede conocer ya la nueva rentabilidad de las oficinas. 

```{r}

i= 5
r.n = c()
while (i<=47) {
  n=fon[i]
  m= d.f[[i]][[4]][61] 
  l= d.f[[i]][[2]][61]
  r=(m+n)/l
  if(r== "NaN"|| r== "Inf"){
    r.n[i]=0
  }else{
    r.n[i]= r
  }
  
  i=i+1
}

r.n

```

### GRAFICAS DE RENTABILIDAD

Se grafica la rentabilidad anterior y la nueva para conocer que tanta variación se puede observar.

```{r}

rentas = data.frame("CODIGO"= oficina$IMPORTANCIA[5:47] , "Rentabilidad_Nueva" = r.n[5:47],"Rentabilidad_Anterior"= rb[5:47])
rentas

grafrica_ra = ggplot(rentas,aes(x= CODIGO,y= Rentabilidad_Anterior))+ geom_line( color="grey") + geom_point(shape=21, color="black", fill="blue", size=3) + ggtitle("RENTABILIDAD ANTERIOR")
grafrica_ra = grafrica_ra + xlab("OFICINA")+ ylab("RENTABILIDAD")+ geom_hline(yintercept=0,colour = "red")
grafrica_ra

grafrica_rn = ggplot(rentas,aes(x= CODIGO,y= Rentabilidad_Nueva))+ geom_line( color="grey") + geom_point(shape=21, color="black", fill="blue", size=3) + ggtitle("RENTABILIDAD NUEVA")
grafrica_rn = grafrica_rn + xlab("OFICINA")+ ylab("RENTABILIDAD")+ geom_hline(yintercept=0,colour = "red")
grafrica_rn

```

### VECTOR DE ACTIVOS

Se crea una data con los activos de la empresa para poder realizar una clasificaciÓn.

```{r}

i=5
activos = c()
while (i<=47) {
  activos[i] = d.f[[i]][[4]][8]
  i=i+1
}
activos

```

### BASE DE DATOS

Se crea una data.frame para organizar por grupo de activo las oficinas de fincomercio.

```{r}

OFICINAS = oficina$OFICINA[5:47]
str(OFICINAS)

CODIGO = oficina$SERIE[5:47]
str(CODIGO)

RENTABILIDAD_ANTERIOR= rb[5:47]
str(RENTABILIDAD_ANTERIOR)

RENTABILIDAD_ACTUAL=r.n[5:47]
str(RENTABILIDAD_ACTUAL)

ACTIVOS = activos[5:47]
str(ACTIVOS)


Fincomercio_Base = data.frame(OFICINAS,CODIGO,RENTABILIDAD_ANTERIOR,RENTABILIDAD_ACTUAL,ACTIVOS)
View(Fincomercio_Base)
Fincomercio_Base[1:5,1:5]

```

### CLASIFICACION POR GRUPOS

Se clasifica las oficinas por grupo de activos y  se saca la media de casa uno de los grupos.

```{r}

grupo.1 = Fincomercio_Base[Fincomercio_Base$ACTIVOS>5000000,]
grupo.1
m.1 = mean(grupo.1$RENTABILIDAD_ACTUAL)
m.1


grupo.2= Fincomercio_Base[Fincomercio_Base$ACTIVOS<5000000 & Fincomercio_Base$ACTIVOS >3000000,]
grupo.2
m.2 = mean(grupo.2$RENTABILIDAD_ACTUAL)
m.2

grupo.3 = Fincomercio_Base[Fincomercio_Base$ACTIVOS<3000000 & Fincomercio_Base$ACTIVOS >1000000,]
grupo.3
m.3 = mean(grupo.3$RENTABILIDAD_ACTUAL)
m.3


grupo.4 = Fincomercio_Base[Fincomercio_Base$ACTIVOS<1000000,]
grupo.4
m.4 = mean(grupo.4$RENTABILIDAD_ACTUAL)
m.4

```

### ALERTAS

Se crean alertas de las oficinas cuyas rentabilidades estan por debajo de la medias de sus respectivos grupos. 


```{r}

alerta.1 = grupo.1[grupo.1$RENTABILIDAD_ACTUAL<m.1,]
alerta.1
g.1 = ggplot(grupo.1,mapping = aes(CODIGO,RENTABILIDAD_ACTUAL, colour= OFICINAS)) + geom_point(shape=21, color="black", fill="green", size=3) + xlab("CODIGO OFICINA")+ ylab("RENTABILIDAD")
g.1=g.1+ ggtitle("RENTABILIDAD GRUPO 1") + geom_hline(yintercept=m.1,colour = "red")
g.1

alerta.2 = grupo.2[grupo.2$RENTABILIDAD_ACTUAL<m.2,]
alerta.2
g.2 = ggplot(grupo.2,mapping = aes(CODIGO,RENTABILIDAD_ACTUAL, colour= OFICINAS)) + geom_point(shape=21, color="black", fill="purple", size=3) + xlab("CODIGO OFICINA")+ ylab("RENTABILIDAD")
g.2=g.2+ ggtitle("RENTABILIDAD GRUPO 2") + geom_hline(yintercept=m.2,colour = "red")
g.2

alerta.3 = grupo.3[grupo.3$RENTABILIDAD_ACTUAL<m.3,]
alerta.3
g.3 = ggplot(grupo.3,mapping = aes(CODIGO,RENTABILIDAD_ACTUAL,colour = OFICINAS)) + geom_point(shape=21, color="black", fill="orange", size=3) + xlab("CODIGO OFICINA")+ ylab("RENTABILIDAD")
g.3=g.3+ ggtitle("RENTABILIDAD GRUPO 3") + geom_hline(yintercept=m.3,colour = "red")
g.3

alerta.4 = grupo.4[grupo.4$RENTABILIDAD_ACTUAL<m.4,]
alerta.4
g.4 = ggplot(grupo.4,mapping = aes(CODIGO,RENTABILIDAD_ACTUAL,colour = OFICINAS)) + geom_point(shape=21, color="black", fill="yellow", size=3) + xlab("CODIGO OFICINA")+ ylab("RENTABILIDAD")
g.4=g.4+ ggtitle("RENTABILIDAD GRUPO 4") + geom_hline(yintercept=m.4,colour = "red")
g.4

```
